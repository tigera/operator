version: v1.0
name: Operator CD
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2004
global_job_config:
  secrets:
    - name: docker-hub
    - name: oss-release-secrets
    # Mount the github SSH secret for pulling private repositories.
    - name: private-repo
    - name: secret-manager-gcloud-credentials
  prologue:
    commands:
      # Correct permissions since they are too open by default:
      - chmod 0600 ~/.keys/*
      # Add the key to the ssh agent:
      - ssh-add ~/.keys/*

      # Clone our secret tool from Github and install it
      - git config --global url."ssh://git@github.com/".insteadOf "https://github.com/"
      - export GOPRIVATE="github.com/tigera/*,github.com/danudey/*"
      - git clone -b add-secret-tool-properly git@github.com:danudey/go-tools.git go-tools
      - cd go-tools && go install -v ./cmd/secret-tool

      # Add default GOBIN to our path
      - export PATH=$HOME/go/bin:$PATH

      # Log into docker hub (we log into quay.io later for some reason)
      - secret-tool fetch-secret DOCKERHUB_PASSWORD | docker login --username $(secret-tool fetch-secret DOCKERHUB_USERNAME) --password-stdin

      # Checkout our code
      - checkout

      # Restore all the build specific caches
      - 'cache restore bin-amd64-${SEMAPHORE_GIT_SHA}'
      - 'cache restore go-pkg-cache-amd64-${SEMAPHORE_GIT_SHA}'
      - 'cache restore go-mod-cache-amd64-${SEMAPHORE_GIT_SHA}'
      - 'cache restore bin-arm64-${SEMAPHORE_GIT_SHA}'
      - 'cache restore go-pkg-cache-arm64-${SEMAPHORE_GIT_SHA}'
      - 'cache restore go-mod-cache-arm64-${SEMAPHORE_GIT_SHA}'
      - 'cache restore bin-ppc64le-${SEMAPHORE_GIT_SHA}'
      - 'cache restore go-pkg-cache-ppc64le-${SEMAPHORE_GIT_SHA}'
      - 'cache restore go-mod-cache-ppc64le-${SEMAPHORE_GIT_SHA}'
      - 'cache restore bin-s390x-${SEMAPHORE_GIT_SHA}'
      - 'cache restore go-pkg-cache-s390x-${SEMAPHORE_GIT_SHA}'
      - 'cache restore go-mod-cache-s390x-${SEMAPHORE_GIT_SHA}'

blocks:
  - name: Push Images / Maybe Release
    task:
      secrets:
        - name: quay-robot-semaphore_v2
        - name: operator-redhat-connect
      prologue:
        commands:
          # Sign in to quay.io using fetched secrets
          - secret-tool fetch-secret QUAY_TOKEN | docker login --username $(secret-tool fetch-secret QUAY_USERNAME) --password-stdin quay.io
          - export BRANCH_NAME=$SEMAPHORE_GIT_BRANCH
      jobs:
        - name: Build
          commands:
            - make cd
          env_vars:
            - name: CONFIRM
              value: "true"

promotions:
  - name: Clean Up
    pipeline_file: clean_up.yml
    # Auto promote to clean up since this likely wasn't promoted from the CI pipeline (since we only promote to the
    # clean up pipeline if we're not running on master or a release branch).
    # We only auto promote if the cd has passed, because if it's failed we'll likely just want to run CD again, but if
    # we've cleared the cache it will take a long time.
    auto_promote:
      when: "result = 'passed'"
